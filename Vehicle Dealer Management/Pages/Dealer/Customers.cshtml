@page
@model Vehicle_Dealer_Management.Pages.Dealer.CustomersModel
@{
    ViewData["Title"] = "Quản lý khách hàng";
    // UserRole and UserName are set in code-behind from Session
}

@await Html.PartialAsync("_PageHeader")

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Quản lý khách hàng</h1>
            <p class="content-subtitle">Danh sách và hồ sơ khách hàng</p>
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display='flex'">
            <i class="bi bi-person-plus"></i> Thêm khách hàng
        </button>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-4 mb-4">
    <div class="stat-card">
        <div class="stat-label">Tổng khách hàng</div>
        <div class="stat-value">@Model.TotalCustomers</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Khách mới (tháng)</div>
        <div class="stat-value" style="color: var(--success);">@Model.NewCustomers</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Có tài khoản</div>
        <div class="stat-value" style="color: var(--info);">@Model.WithAccount</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Đã mua xe</div>
        <div class="stat-value" style="color: var(--accent-cyan);">@Model.WithPurchase</div>
    </div>
</div>

<!-- Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="grid grid-cols-4 gap-2">
                <div style="grid-column: span 2;">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Tìm theo tên, email, số điện thoại..." 
                           value="@Model.SearchQuery" />
                </div>
                <select name="filter" class="form-control">
                    <option value="">Tất cả</option>
                    <option value="hasAccount" @(Model.FilterType == "hasAccount" ? "selected" : "")>Có tài khoản</option>
                    <option value="withPurchase" @(Model.FilterType == "withPurchase" ? "selected" : "")>Đã mua xe</option>
                    <option value="noPurchase" @(Model.FilterType == "noPurchase" ? "selected" : "")>Chưa mua xe</option>
                </select>
                <div class="flex gap-1">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                    @if (!string.IsNullOrEmpty(Model.SearchQuery) || !string.IsNullOrEmpty(Model.FilterType))
                    {
                        <a href="/Dealer/Customers" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Xóa
                        </a>
                    }
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Customers Table -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Họ tên</th>
                        <th>Số điện thoại</th>
                        <th>Email</th>
                        <th>Địa chỉ</th>
                        <th>Đơn hàng</th>
                        <th>Tổng chi tiêu</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var customer in Model.Customers)
                    {
                        <tr>
                            <td><strong>#@customer.Id</strong></td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                        @customer.FullName.Substring(0, 1).ToUpper()
                                    </div>
                                    <div>
                                        <div><strong>@customer.FullName</strong></div>
                                        @if (customer.HasAccount)
                                        {
                                            <div style="font-size: 0.75rem; color: var(--success);">
                                                <i class="bi bi-check-circle-fill"></i> Có tài khoản
                                            </div>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>@customer.Phone</td>
                            <td class="text-muted">@customer.Email</td>
                            <td class="text-muted">@customer.Address</td>
                            <td>
                                @if (customer.OrderCount > 0)
                                {
                                    <strong style="color: var(--accent-cyan);">@customer.OrderCount</strong>
                                }
                                else
                                {
                                    <span class="text-muted">0</span>
                                }
                            </td>
                            <td>
                                @if (customer.TotalSpent > 0)
                                {
                                    <strong>@customer.TotalSpent.ToString("N0") VND</strong>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button class="btn btn-secondary btn-sm" onclick="editCustomer(@customer.Id, '@Html.Raw(customer.FullName.Replace("'", "\\'"))', '@Html.Raw(customer.Phone.Replace("'", "\\'"))', '@Html.Raw(customer.Email.Replace("'", "\\'"))', '@Html.Raw((customer.Address ?? "").Replace("'", "\\'"))')">
                                        <i class="bi bi-pencil"></i> Sửa
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="card-header">
            <h3 class="card-title mb-0">Thêm khách hàng mới</h3>
        </div>
        <div class="card-body">
            <form method="post">
                <div class="form-group">
                    <label class="form-label">Họ và tên</label>
                    <input type="text" class="form-control" name="fullName" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Số điện thoại</label>
                    <input type="tel" class="form-control" name="phone" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="email" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Địa chỉ</label>
                    <textarea class="form-control" name="address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Số CMND/CCCD (Tùy chọn)</label>
                    <input type="text" class="form-control" name="identityNo" />
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Tạo khách hàng
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('createModal').style.display='none'">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="card-header">
            <h3 class="card-title mb-0">Chỉnh sửa khách hàng</h3>
        </div>
        <div class="card-body">
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-error" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--error-bg); border: 1px solid var(--error); border-radius: var(--radius-sm); color: var(--error);">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
                </div>
            }
            <form method="post" asp-page-handler="UpdateCustomer">
                <input type="hidden" id="editCustomerId" name="customerId" />
                <div class="form-group">
                    <label class="form-label">Họ và tên</label>
                    <input type="text" class="form-control" id="editFullName" name="fullName" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Số điện thoại</label>
                    <input type="tel" class="form-control" id="editPhone" name="phone" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="editEmail" name="email" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Địa chỉ</label>
                    <textarea class="form-control" id="editAddress" name="address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Số CMND/CCCD (Tùy chọn)</label>
                    <input type="text" class="form-control" id="editIdentityNo" name="identityNo" />
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Cập nhật
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('editModal').style.display='none'">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div id="successToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1rem 1.5rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius); color: var(--success); box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <i class="bi bi-check-circle"></i> @TempData["Success"]
    </div>
    <script>
        setTimeout(function() {
            var toast = document.getElementById('successToast');
            if (toast) toast.style.display = 'none';
        }, 3000);
    </script>
}

@section Scripts {
    <script>
        function editCustomer(id, fullName, phone, email, address) {
            document.getElementById('editCustomerId').value = id;
            document.getElementById('editFullName').value = fullName || '';
            document.getElementById('editPhone').value = phone || '';
            document.getElementById('editEmail').value = email || '';
            document.getElementById('editAddress').value = address || '';
            document.getElementById('editModal').style.display = 'flex';
        }
    </script>
}

